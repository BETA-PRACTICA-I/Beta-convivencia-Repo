{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Protocolo #{{ protocolo.id }}</title>
    <style>
        @page { size: A4; margin: 1.5cm; }
        body { font-family: "Helvetica", "Arial", sans-serif; line-height: 1.6; font-size: 11pt; }
        h1, h2, h3 { color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 6px; margin-top: 25px; }
        h1 { font-size: 22pt; text-align: center; border: none; }
        h2 { font-size: 16pt; }
        h3 { font-size: 13pt; border-bottom: 1px solid #bdc3c7; }
        p { margin: 8px 0; }
        strong { color: #34495e; }
        pre { background-color: #ecf0f1; padding: 15px; white-space: pre-wrap; word-wrap: break-word; border-left: 3px solid #3498db; font-family: "Courier New", monospace; }
        .header { text-align: center; margin-bottom: 40px; }
        .section { margin-bottom: 20px; page-break-inside: avoid; }
        .footer { position: fixed; bottom: -1cm; left: 0; right: 0; height: 1cm; text-align: center; font-size: 9pt; color: #7f8c8d; }
        
        /* Estilos para las imágenes del anexo */
        .anexo-imagen { 
            width: 100%; 
            max-height: 22cm; /* Evita que la imagen sea más grande que la página */
            object-fit: contain;
            margin-top: 1rem; 
            page-break-before: always; /* Pone cada imagen en una nueva página */
        }
    </style>
</head>
<body>
    <div class="footer">
        Documento generado el {{ fecha_actual|date:"d/m/Y H:i" }} por {{ request.user.get_full_name|default:request.user.username }}.
    </div>

    <div class="header">
        <h1>Informe de Protocolo #{{ protocolo.id }}</h1>
        <p><strong>Tipo de Protocolo:</strong> {{ protocolo.tipo.nombre }}</p>
        <p><strong>Estado Actual:</strong> {{ protocolo.estado }}</p>
        <p><strong>Fecha de Apertura:</strong> {{ protocolo.fecha_creacion|date:"d/m/Y" }}</p>
    </div>

    {% with p=protocolo %}

    {# --- PROTOCOLOS 1-7 --- #}
    {% if protocolo.tipo.nombre in protocolos_tipo_1 %}

        {% if p.ficha_denuncia %}
        <div class="section">
            <h2>Paso 1: Formulario de Denuncia</h2>
            <p><strong>Nombre Denunciante:</strong> {{ p.ficha_denuncia.nombre_denunciante|default:"No especificado" }}</p>
            <p><strong>RUT Denunciante:</strong> {{ p.ficha_denuncia.run_denunciante|default:"No especificado" }}</p>
            <p><strong>Nombre Denunciado:</strong> {{ p.ficha_denuncia.nombre_denunciado|default:"No especificado" }}</p>
            <p><strong>Curso Denunciado:</strong> {{ p.ficha_denuncia.curso_denunciado|default:"No especificado" }}</p>
            <h3>Descripción de los Hechos:</h3>
            <pre>{{ p.ficha_denuncia.descripcion|default:"Sin descripción." }}</pre>
            <h3>Testigos:</h3>
            <pre>{{ p.ficha_denuncia.testigos|default:"Sin testigos." }}</pre>
        </div>
        {% endif %}

        {% if p.fichaentrevista %}
        <div class="section">
            <h2>Paso 2: Ficha de Entrevista</h2>
            <p><strong>Fecha y Hora:</strong> {{ p.fichaentrevista.fecha_hora|default:"No especificado" }}</p>
            <p><strong>Nombre Entrevistado:</strong> {{ p.fichaentrevista.nombre_entrevistado|default:"No especificado" }}</p>
            <h3>Resumen de la Entrevista:</h3>
            <pre>{{ p.fichaentrevista.contenido_entrevista|default:"Sin resumen." }}</pre>
        </div>
        {% endif %}

        {% if p.derivacion %}
        <div class="section">
            <h2>Paso 3: Derivaciones</h2>
            <p><strong>Derivación a:</strong> {{ p.derivacion.derivaciones|default:"No especificado" }}</p>
            <h3>Descripción Detallada (si aplica):</h3>
            {% if 'constatar_lesiones' in p.derivacion.derivaciones %}
                <p><strong>Lesiones - Institución:</strong> {{ p.derivacion.institucion_lesiones|default:"N/A" }}</p>
            {% endif %}
            {% if 'denuncia_delito' in p.derivacion.derivaciones %}
                <p><strong>Delito - Institución:</strong> {{ p.derivacion.institucion_delito|default:"N/A" }}</p>
            {% endif %}
            {% if 'tribunal_familia' in p.derivacion.derivaciones %}
                <p><strong>Tribunal - Institución:</strong> {{ p.derivacion.institucion_tribunal|default:"N/A" }}</p>
            {% endif %}
            {% if 'otras' in p.derivacion.derivaciones %}
                <p><strong>Otras - Tipo:</strong> {{ p.derivacion.tipo_medida_otras|default:"N/A" }}</p>
                <pre>{{ p.derivacion.descripcion_otras|default:"Sin descripción." }}</pre>
            {% endif %}
        </div>
        {% endif %}

        {% if p.informeconcluyente %}
        <div class="section">
            <h2>Paso 4: Informe Concluyente</h2>
            <p><strong>Fecha del Informe:</strong> {{ p.informeconcluyente.fecha_informe|date:"d/m/Y" }}</p>
            <h3>Acciones Realizadas:</h3>
            <pre>{{ p.informeconcluyente.descripcion_accion|default:"Sin descripción." }}</pre>
            <h3>Conclusiones:</h3>
            <pre>{{ p.informeconcluyente.conclusiones|default:"Sin conclusiones." }}</pre>
            <h3>Medidas y Sanciones:</h3>
            <p><strong>Sanción:</strong> {{ p.informeconcluyente.sancion|default:"N/A" }}</p>
            <pre>{{ p.informeconcluyente.descripcion_sancion|default:"Sin descripción." }}</pre>
            <p><strong>Medida:</strong> {{ p.informeconcluyente.medida|default:"N/A" }}</p>
            <pre>{{ p.informeconcluyente.descripcion_medida|default:"Sin descripción." }}</pre>
        </div>
        {% endif %}

        {% if p.apelacion %}
        <div class="section">
            <h2>Paso 5: Apelación</h2>
            <p><strong>Fecha de Recepción:</strong> {{ p.apelacion.fecha_recepcion|date:"d/m/Y" }}</p>
            <p><strong>Presentada por:</strong> {{ p.apelacion.nombre_apelante|default:"No especificado" }}</p>
            <h3>Argumentos de la Apelación:</h3>
            <pre>{{ p.apelacion.texto_apelacion|default:"Sin argumentos." }}</pre>
        </div>
        {% endif %}

        {% if p.resolucionapelacion %}
        <div class="section">
            <h2>Paso 6: Resolución de Apelación</h2>
            <p><strong>Fecha de Recepción:</strong> {{ p.resolucionapelacion.fecha_recepcion|date:"d/m/Y" }}</p>
            <p><strong>Resolución:</strong> {{ p.resolucionapelacion.resolucion|default:"No especificado" }}</p>
            <h3>Fundamentos de la Resolución:</h3>
            <pre>{{ p.resolucionapelacion.fundamentos|default:"Sin fundamentos." }}</pre>
        </div>
        {% endif %}

        {% if p.encuestabullying %}
        <div class="section">
            <h2>Paso 7: Encuesta de Bullying</h2>
            <p><strong>Fecha Encuesta:</strong> {{ p.encuestabullying.fecha_encuesta|date:"d/m/Y"|default:"No especificado" }}</p>
            <p><strong>Edad del Estudiante:</strong> {{ p.encuestabullying.edad_estudiante|default:"No especificado" }}</p>
            <p><strong>Género:</strong> {{ p.encuestabullying.get_genero_estudiante_display|default:"No especificado" }}</p>
            <p><strong>Comentario Adicional:</strong></p>
            <pre>{{ p.encuestabullying.comentario_adicional|default:"Sin comentarios." }}</pre>
        </div>
        {% endif %}
    
    {% endif %} {# --- FIN P1-7 --- #}
    

    {# --- PROTOCOLO 7: RIESGO SUICIDA --- #}
    {% if p.riesgo_suicida_anexo1 %}
    <div class="section">
        <h2>Riesgo Suicida - Paso 1: Anexo 1: Detección</h2>
        <p><strong>Nombre Afectado:</strong> {{ p.riesgo_suicida_anexo1.nombre_afectado|default:"No especificado" }}</p>
        <p><strong>Curso:</strong> {{ p.riesgo_suicida_anexo1.curso|default:"No especificado" }}</p>
        <h3>Registro de situación</h3>
        <p><strong>Fecha Detección:</strong> {{ p.riesgo_suicida_anexo1.fecha|date:"d/m/Y"|default:"No especificado" }}</p>
        <p><strong>Hora Detección:</strong> {{ p.riesgo_suicida_anexo1.hora|time:"H:i"|default:"No especificado" }}</p>
        <h3>Relato de los Hechos:</h3>
        <pre>{{ p.riesgo_suicida_anexo1.relato_hechos|default:"Sin relato." }}</pre>
    </div>
    {% endif %}

    {% if p.riesgo_suicida_anexo2 %}
    <div class="section">
        <h2>Riesgo Suicida - Paso 2: Anexo 2: Derivación</h2>
        <h3>1. Antecedentes Establecimiento</h3>
        <p><strong>Fecha Derivación:</strong> {{ p.riesgo_suicida_anexo2.fecha_derivacion|date:"d/m/Y"|default:"No especificado" }}</p>
        <p><strong>Profesional que Deriva:</strong> {{ p.riesgo_suicida_anexo2.profesional_deriva_nombre|default:"N/A" }} ({{ p.riesgo_suicida_anexo2.profesional_deriva_cargo|default:"N/A" }})</p>
        <h3>2. Antecedentes Estudiante</h3>
        <p><strong>Nombre Estudiante:</strong> {{ p.riesgo_suicida_anexo2.estudiante_nombre|default:"No especificado" }}</p>
        <p><strong>RUN:</strong> {{ p.riesgo_suicida_anexo2.estudiante_run|default:"No especificado" }}</p>
        <h3>3. Motivo Derivación</h3>
        <pre>{{ p.riesgo_suicida_anexo2.motivo_derivacion|default:"Sin motivo especificado." }}</pre>
        <h3>4. Acciones Efectuadas</h3>
        <pre>{{ p.riesgo_suicida_anexo2.acciones_efectuadas|default:"Sin acciones especificadas." }}</pre>
    </div>
    {% endif %}

    {% if p.riesgo_suicida_anexo3 %}
    <div class="section">
        <h2>Riesgo Suicida - Paso 3: Anexo 3: Notificación Apoderado</h2>
        <p><strong>Fecha Notificación:</strong> {{ p.riesgo_suicida_anexo3.fecha|date:"d/m/Y"|default:"N/A" }}</p>
        <p><strong>Hora Notificación:</strong> {{ p.riesgo_suicida_anexo3.hora|time:"H:i"|default:"N/A" }}</p>
        <p><strong>Apoderado Notificado:</strong> {{ p.riesgo_suicida_anexo3.apoderado_nombre|default:"N/A" }}</p>
        <p><strong>Funcionario Notificante:</strong> {{ p.riesgo_suicida_anexo3.nombre_firma_funcionario|default:"N/A" }}</p>
        <h3>Acciones a seguir por el apoderado:</h3>
        <pre>{{ p.riesgo_suicida_anexo3.acciones_a_seguir|default:"Sin acciones especificadas." }}</pre>
    </div>
    {% endif %}

    {% if p.riesgo_suicida_anexo4 %}
    <div class="section">
        <h2>Riesgo Suicida - Paso 4: Anexo 4: Reunión Clínica</h2>
        <p><strong>Fecha Reunión:</strong> {{ p.riesgo_suicida_anexo4.fecha|date:"d/m/Y"|default:"N/A" }}</p>
        <h3>Asistentes:</h3>
        <pre>{{ p.riesgo_suicida_anexo4.asistentes|default:"No especificados." }}</pre>
        <h3>Puntos Tratados:</h3>
        <pre>{{ p.riesgo_suicida_anexo4.puntos_tratados|default:"No especificados." }}</pre>
        <h3>Acuerdos y Compromisos:</h3>
        <pre>{{ p.riesgo_suicida_anexo4.acuerdos|default:"No especificados." }}</pre>
    </div>
    {% endif %}

    {% if p.riesgo_suicida_anexo5 %}
    <div class="section">
        <h2>Riesgo Suicida - Paso 5: Anexo 5: Hoja de Derivación</h2>
        <p><strong>Fecha Derivación:</strong> {{ p.riesgo_suicida_anexo5.fecha_derivacion|date:"d/m/Y"|default:"N/A" }}</p>
        <h3>Motivo de Derivación:</h3>
        <pre>{{ p.riesgo_suicida_anexo5.motivo_derivacion|default:"No especificado." }}</pre>
        <p><strong>Funcionario Responsable:</strong> {{ p.riesgo_suicida_anexo5.responsable_nombre|default:"N/A" }}</p>
    </div>
    {% endif %}

    {# --- PROTOCOLO 8: CASOS DE SALUD --- #}
    {% if p.ficha_accidente_escolar %}
    <div class="section">
        <h2>Ficha de Accidente Escolar</h2>
        <p><strong>Estudiante:</strong> {{ p.ficha_accidente_escolar.estudiante_nombre|default:"N/A" }}</p>
        <p><strong>Fecha y Hora:</strong> {{ p.ficha_accidente_escolar.fecha_hora_accidente|date:"d/m/Y H:i"|default:"N/A" }}</p>
        <h3>Descripción del Accidente:</h3>
        <pre>{{ p.ficha_accidente_escolar.descripcion_accidente|default:"Sin descripción." }}</pre>
        <h3>Primeros Auxilios Realizados:</h3>
        <pre>{{ p.ficha_accidente_escolar.primeros_auxilios|default:"Sin descripción." }}</pre>
    </div>
    {% endif %}
    
    {# --- PROTOCOLO 9: DATOS DE ARMAS --- #}
    {% if p.anexo_armas %}
    <div class="section">
        <h2>Datos del Estudiante (Protocolo Armas)</h2>
        <p><strong>Nombre:</strong> {{ p.anexo_armas.nombre_estudiante }}</p>
        <p><strong>Curso:</strong> {{ p.anexo_armas.curso }}</p>
        <p><strong>RUT:</strong> {{ p.anexo_armas.rut }}</p>
        
        <h3 style="border:none; margin-top: 15px;">Descripción de la situación</h3>
        <pre>{{ p.anexo_armas.descripcion|linebreaks }}</pre>
    </div>
    {% endif %}

    {# --- PROTOCOLO 10: DATOS DE AUTOLESIÓN --- #}
    {% if p.anexo_autolesion %}
    <div class="section">
        <h2>Datos del Estudiante (Protocolo Autolesión)</h2>
        <p><strong>Nombre:</strong> {{ p.anexo_autolesion.nombre_estudiante }}</p>
        <p><strong>Curso:</strong> {{ p.anexo_autolesion.curso }}</p>
        <p><strong>RUT:</strong> {{ p.anexo_autolesion.rut }}</p>
        
        <h3 style="border:none; margin-top: 15px;">Descripción de la situación</h3>
        <pre>{{ p.anexo_autolesion.descripcion|linebreaks }}</pre>
    </div>
    {% endif %}

    <!-- --- ¡NUEVO! MOSTRAR DATOS PROTOCOLO 11: ESTUDIANTES MADRES/PADRES --- -->
    {% if p.ficha0_madre_padre %}
    <div class="section">
        <h2>Paso 1: Ficha 0 - Citación y Constancia</h2>
        
        <h3 style="border-bottom: 1px solid #bdc3c7;">Constancia de Citación</h3>
        <p><strong>Nombre Alumna/o:</strong> {{ p.ficha0_madre_padre.nombre_estudiante|default:"N/A" }}</p>
        <p><strong>Curso:</strong> {{ p.ficha0_madre_padre.curso|default:"N/A" }}</p>
        <p><strong>Fecha Citación:</strong> {{ p.ficha0_madre_padre.fecha_citacion|date:"d/m/Y"|default:"N/A" }}</p>
        <p><strong>Apoderado Citado:</strong> {{ p.ficha0_madre_padre.nombre_apoderado_citado|default:"N/A" }}</p>
        <p><strong>Medio de Citación:</strong> {{ p.ficha0_madre_padre.medio_citacion|default:"N/A" }}</p>
        <p><strong>Fecha Citado a Concurrir:</strong> {{ p.ficha0_madre_padre.fecha_concurrencia_citada|date:"d/m/Y"|default:"N/A" }}</p>
        <p><strong>Funcionario que Cita:</strong> {{ p.ficha0_madre_padre.funcionario_que_cita|default:"N/A" }}</p>

        <h3 style="border-bottom: 1px solid #bdc3c7; margin-top: 25px;">Constancia de Haber Concurrido</h3>
        <p><strong>Apoderado que Concurre:</strong> {{ p.ficha0_madre_padre.nombre_apoderado_concurre|default:"N/A" }}</p>
        <p><strong>RUT Apoderado:</strong> {{ p.ficha0_madre_padre.rut_apoderado_concurre|default:"N/A" }}</p>
    </div>
    {% endif %}

    {% if p.ficha1_madre_padre %}
    <div class="section">
        <h2>Paso 2: Ficha 1 - Entrevista con Apoderado</h2>
        
        <p><strong>Fecha Entrevista:</strong> {{ p.ficha1_madre_padre.fecha_entrevista|date:"d/m/Y"|default:"N/A" }}</p>
        <p><strong>Individualización Apoderado:</strong> {{ p.ficha1_madre_padre.individualizacion_apoderado|default:"N/A" }}</p>
        
        <h3 style="border:none; margin-top: 15px;">Motivo de la entrevista</h3>
        <pre>{{ p.ficha1_madre_padre.motivo_entrevista|linebreaks|default:"Sin descripción." }}</pre>

        <h3 style="border:none; margin-top: 15px;">Aspectos relevantes de la entrevista</h3>
        <pre>{{ p.ficha1_madre_padre.aspectos_relevantes|linebreaks|default:"Sin descripción." }}</pre>
        
        <h3 style="border-bottom: 1px solid #bdc3c7; margin-top: 25px;">Firmas de Constancia</h3>
        <p><strong>Funcionario:</strong> {{ p.ficha1_madre_padre.nombre_firma_funcionario|default:"N/A" }}</p>
        <p><strong>Apoderado:</strong> {{ p.ficha1_madre_padre.nombre_firma_apoderado|default:"N/A" }}</p>
    </div>
    {% endif %}

    {% if p.ficha2_madre_padre %}
    <div class="section">
        <h2>Paso 3: Ficha 2 - Cierre de Protocolo</h2>
        
        <h3 style="border-bottom: 1px solid #bdc3c7;">Datos del Cierre</h3>
        <p><strong>Nombre Alumna/o:</strong> {{ p.ficha2_madre_padre.nombre_estudiante|default:"N/A" }}</p>
        <p><strong>Curso:</strong> {{ p.ficha2_madre_padre.curso|default:"N/A" }}</p>
        <p><strong>Fecha Informe Final:</strong> {{ p.ficha2_madre_padre.fecha_informe_final|date:"d/m/Y"|default:"N/A" }}</p>
        <p><strong>Fecha Cierre Protocolo:</strong> {{ p.ficha2_madre_padre.fecha_cierre_protocolo|date:"d/m/Y"|default:"N/A" }}</p>
        <p><strong>Quién elabora el informe:</strong> {{ p.ficha2_madre_padre.quien_elabora_informe|default:"N/A" }}</p>
        <p><strong>Funcionario que recibe el informe:</strong> {{ p.ficha2_madre_padre.funcionario_recibe_informe|default:"N/A" }}</p>

        <h3 style="border-bottom: 1px solid #bdc3c7; margin-top: 25px;">Firmas de Constancia</h3>
        <p><strong>Funcionario que elabora:</strong> {{ p.ficha2_madre_padre.firma_funcionario_elabora|default:"N/A" }}</p>
        <p><strong>Rector/a:</strong> {{ p.ficha2_madre_padre.firma_rector|default:"N/A" }}</p>
    </div>
    {% endif %}
    <!-- --- FIN BLOQUE P11 --- -->


    {% endwith %}


    {# --- ANEXOS P9: IMÁGENES ESTÁTICAS DE ARMAS --- #}
    {% if protocolo.tipo.nombre == "Armas blancas y de fuego" %}
        <div class="section">
            <h2 style="page-break-before: always;">Anexo: Procedimiento de Actuación</h2>
            <p>A continuación, se adjunta el protocolo de actuación estándar:</p>
        </div>
        
        <img src="/static/img/protocolo9/9.- PROTOCOLO-ARMAS-BLANCAS-Y-DE-FUEGO-Listo_page-0001.jpg" class="anexo-imagen" alt="Protocolo Armas Portada">
        <img src="/static/img/protocolo9/9.- PROTOCOLO-ARMAS-BLANCAS-Y-DE-FUEGO-Listo_page-0002.jpg" class="anexo-imagen" alt="Protocolo Armas Página 2">
        <img src="/static/img/protocolo9/9.- PROTOCOLO-ARMAS-BLANCAS-Y-DE-FUEGO-Listo_page-0003.jpg" class="anexo-imagen" alt="Protocolo Armas Página 3">
        <img src="/static/img/protocolo9/9.- PROTOCOLO-ARMAS-BLANCAS-Y-DE-FUEGO-Listo_page-0004.jpg" class="anexo-imagen" alt="Protocolo Armas Página 4">
        <img src="/static/img/protocolo9/9.- PROTOCOLO-ARMAS-BLANCAS-Y-DE-FUEGO-Listo_page-0005.jpg" class="anexo-imagen" alt="Protocolo Armas Flujograma">

    {% endif %}

    {# --- ANEXOS P10: IMÁGENES ESTÁTICAS DE AUTOLESIÓN --- #}
    {% if protocolo.tipo.nombre == "Autolesión" %}
        <div class="section">
            <h2 style="page-break-before: always;">Anexo: Procedimiento de Actuación (Autolesión)</h2>
            <p>A continuación, se adjunta el protocolo de actuación estándar:</p>
        </div>
        
        <img src="/static/img/protocolo10/10.- PROTOCOLO-de actuacion ante situaciones de autolesión de los estudiantes Listo_page-0001.jpg" class="anexo-imagen" alt="Protocolo Autolesión Página 1">
        <img src="/static/img/protocolo10/10.- PROTOCOLO-de actuacion ante situaciones de autolesión de los estudiantes Listo_page-0002.jpg" class="anexo-imagen" alt="Protocolo Autolesión Página 2">
        <img src="/static/img/protocolo10/10.- PROTOCOLO-de actuacion ante situaciones de autolesión de los estudiantes Listo_page-0003.jpg" class="anexo-imagen" alt="Protocolo Autolesión Página 3">
        <img src="/static/img/protocolo10/10.- PROTOCOLO-de actuacion ante situaciones de autolesión de los estudiantes Listo_page-0004.jpg" class="anexo-imagen" alt="Protocolo Autolesión Página 4">
        <img src="/static/img/protocolo10/10.- PROTOCOLO-de actuacion ante situaciones de autolesión de los estudiantes Listo_page-0005.jpg" class="anexo-imagen" alt="Protocolo Autolesión Página 5">
        <img src="/static/img/protocolo10/10.- PROTOCOLO-de actuacion ante situaciones de autolesión de los estudiantes Listo_page-0006.jpg" class="anexo-imagen" alt="Protocolo Autolesión Página 6">

    {% endif %}

</body>
</html>

