<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Protocolo #{{ protocolo.id }}</title>
    <style>
        @page { size: A4; margin: 1.5cm; }
        body { font-family: "Helvetica", "Arial", sans-serif; line-height: 1.6; font-size: 11pt; }
        h1, h2, h3 { color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 6px; margin-top: 25px; }
        h1 { font-size: 22pt; text-align: center; border: none; }
        h2 { font-size: 16pt; }
        h3 { font-size: 13pt; border-bottom: 1px solid #bdc3c7; }
        p { margin: 8px 0; }
        strong { color: #34495e; }
        pre { background-color: #ecf0f1; padding: 15px; white-space: pre-wrap; word-wrap: break-word; border-left: 3px solid #3498db; font-family: "Courier New", monospace; }
        .header { text-align: center; margin-bottom: 40px; }
        .section { margin-bottom: 20px; }
        .footer { position: fixed; bottom: -1cm; left: 0; right: 0; height: 1cm; text-align: center; font-size: 9pt; color: #7f8c8d; }
    </style>
</head>
<body>
    <div class="header">
        <h1>Informe de Protocolo #{{ protocolo.id }}</h1>
        <p><strong>Tipo de Protocolo:</strong> {{ protocolo.tipo.nombre }}</p>
        <p><strong>Estado Actual:</strong> {{ protocolo.estado }}</p>
        <p><strong>Fecha de Apertura:</strong> {{ protocolo.fecha_creacion|date:"d/m/Y" }}</p>
    </div>

    {% with p=protocolo %}

    {% if p.ficha_denuncia %}
    <div class="section">
        <h2>Paso 1: Formulario de Denuncia</h2>
        <p><strong>Nombre Denunciante:</strong> {{ p.ficha_denuncia.nombre_denunciante|default:"No especificado" }}</p>
        <p><strong>RUT Denunciante:</strong> {{ p.ficha_denuncia.run_denunciante|default:"No especificado" }}</p>
        {# Corrección: estamento_denunciante no existe #}
        <p><strong>Nombre Denunciado:</strong> {{ p.ficha_denuncia.nombre_denunciado|default:"No especificado" }}</p>
        <p><strong>Curso Denunciado:</strong> {{ p.ficha_denuncia.curso_denunciado|default:"No especificado" }}</p>
        <h3>Descripción de los Hechos:</h3>
        <pre>{{ p.ficha_denuncia.descripcion|default:"Sin descripción." }}</pre> {# Corrección: descripcion_hechos -> descripcion #}
        <h3>Testigos:</h3> {# Corrección: medidas_inmediatas no existe, añadí testigos #}
        <pre>{{ p.ficha_denuncia.testigos|default:"Sin testigos." }}</pre>
    </div>
    {% endif %}

    {% if p.fichaentrevista %}
    <div class="section">
        <h2>Paso 2: Ficha de Entrevista</h2>
        <p><strong>Fecha y Hora:</strong> {{ p.fichaentrevista.fecha_hora|default:"No especificado" }}</p> {# Corrección: fecha_entrevista -> fecha_hora #}
        <p><strong>Nombre Entrevistado:</strong> {{ p.fichaentrevista.nombre_entrevistado|default:"No especificado" }}</p>
        <p><strong>RUT Entrevistado:</strong> {{ p.fichaentrevista.run_entrevistado|default:"No especificado" }}</p>
        {# Corrección: calidad_entrevistado no existe #}
        <h3>Resumen de la Entrevista:</h3>
        <pre>{{ p.fichaentrevista.contenido_entrevista|default:"Sin resumen." }}</pre> {# Corrección: resumen_entrevista -> contenido_entrevista #}
    </div>
    {% endif %}

    {% if p.derivacion %}
    <div class="section">
        <h2>Paso 3: Derivaciones</h2>
        <p><strong>Derivación a:</strong> {{ p.derivacion.derivaciones|default:"No especificado" }}</p> {# Corrección: get_derivaciones_display -> derivaciones #}
         <h3>Descripción Detallada (si aplica):</h3> {# Corrección: No hay campo 'descripcion' general, depende del tipo #}
         {% if 'constatar_lesiones' in p.derivacion.derivaciones %}
            <p><strong>Lesiones - Institución:</strong> {{ p.derivacion.institucion_lesiones|default:"N/A" }}</p>
         {% endif %}
         {% if 'denuncia_delito' in p.derivacion.derivaciones %}
            <p><strong>Delito - Institución:</strong> {{ p.derivacion.institucion_delito|default:"N/A" }}</p>
         {% endif %}
         {% if 'tribunal_familia' in p.derivacion.derivaciones %}
            <p><strong>Tribunal - Institución:</strong> {{ p.derivacion.institucion_tribunal|default:"N/A" }}</p>
         {% endif %}
         {% if 'otras' in p.derivacion.derivaciones %}
            <p><strong>Otras - Tipo:</strong> {{ p.derivacion.tipo_medida_otras|default:"N/A" }}</p>
            <pre>{{ p.derivacion.descripcion_otras|default:"Sin descripción." }}</pre>
         {% endif %}
    </div>
    {% endif %}

    {% if p.informeconcluyente %}
    <div class="section">
        <h2>Paso 4: Informe Concluyente</h2>
        <p><strong>Fecha del Informe:</strong> {{ p.informeconcluyente.fecha_informe|date:"d/m/Y" }}</p>
        <h3>Acciones Realizadas:</h3> {# Corrección: analisis_caso -> descripcion_accion #}
        <pre>{{ p.informeconcluyente.descripcion_accion|default:"Sin descripción." }}</pre>
        <h3>Conclusiones:</h3>
        <pre>{{ p.informeconcluyente.conclusiones|default:"Sin conclusiones." }}</pre>
        <h3>Medidas y Sanciones:</h3> {# Corrección: medidas_sanciones -> Varios campos #}
        <p><strong>Sanción:</strong> {{ p.informeconcluyente.sancion|default:"N/A" }}</p>
        <pre>{{ p.informeconcluyente.descripcion_sancion|default:"Sin descripción." }}</pre>
        <p><strong>Medida:</strong> {{ p.informeconcluyente.medida|default:"N/A" }}</p>
        <pre>{{ p.informeconcluyente.descripcion_medida|default:"Sin descripción." }}</pre>
    </div>
    {% endif %}

    {% if p.apelacion %}
    <div class="section">
        <h2>Paso 5: Apelación</h2>
        <p><strong>Fecha de Recepción:</strong> {{ p.apelacion.fecha_recepcion|date:"d/m/Y" }}</p> {# Corrección: fecha_apelacion -> fecha_recepcion #}
        <p><strong>Presentada por:</strong> {{ p.apelacion.nombre_apelante|default:"No especificado" }}</p> {# Corrección: presentada_por -> nombre_apelante #}
        <h3>Argumentos de la Apelación:</h3>
        <pre>{{ p.apelacion.texto_apelacion|default:"Sin argumentos." }}</pre> {# Corrección: argumentos_apelacion -> texto_apelacion #}
    </div>
    {% endif %}

    {% if p.resolucionapelacion %}
    <div class="section">
        <h2>Paso 6: Resolución de Apelación</h2>
        <p><strong>Fecha de Recepción:</strong> {{ p.resolucionapelacion.fecha_recepcion|date:"d/m/Y" }}</p> {# Corrección: fecha_resolucion -> fecha_recepcion #}
        <p><strong>Resolución:</strong> {{ p.resolucionapelacion.resolucion|default:"No especificado" }}</p>
        <h3>Fundamentos de la Resolución:</h3>
        <pre>{{ p.resolucionapelacion.fundamentos|default:"Sin fundamentos." }}</pre> {# Corrección: fundamentos_resolucion -> fundamentos #}
    </div>
    {% endif %}

    {% if p.encuestabullying %}
    <div class="section">
        <h2>Paso 7: Encuesta de Bullying</h2>
         <p><strong>Fecha Encuesta:</strong> {{ p.encuestabullying.fecha_encuesta|date:"d/m/Y"|default:"No especificado" }}</p> {# Corrección: añadido #}
        <p><strong>Edad del Estudiante:</strong> {{ p.encuestabullying.edad_estudiante|default:"No especificado" }}</p>
        <p><strong>Género:</strong> {{ p.encuestabullying.get_genero_estudiante_display|default:"No especificado" }}</p> {# Corrección: genero_estudiante -> get_genero_estudiante_display #}
        {# Corrección: Los campos tipo_bullying, frecuencia, lugar, respuesta_colegio no existen #}
         <p><strong>Comentario Adicional:</strong></p>
        <pre>{{ p.encuestabullying.comentario_adicional|default:"Sin comentarios." }}</pre>
        {# Aquí podrías mostrar las respuestas de frecuencia si lo deseas #}
    </div>
    {% endif %}

    {% if p.riesgo_suicida_anexo1 %}
    <div class="section">
        <h2>Riesgo Suicida - Paso 1: Anexo 1: Detección</h2>
        <p><strong>Nombre Afectado:</strong> {{ p.riesgo_suicida_anexo1.nombre_afectado|default:"No especificado" }}</p>
        <p><strong>Curso:</strong> {{ p.riesgo_suicida_anexo1.curso|default:"No especificado" }}</p>
        <p><strong>Profesor Jefe:</strong> {{ p.riesgo_suicida_anexo1.profesor_jefe|default:"No especificado" }}</p>
        <p><strong>Apoderado:</strong> {{ p.riesgo_suicida_anexo1.apoderado|default:"No especificado" }}</p>
        <h3>Registro de situación</h3>
        <p><strong>Fecha Detección:</strong> {{ p.riesgo_suicida_anexo1.fecha|date:"d/m/Y"|default:"No especificado" }}</p>
        <p><strong>Hora Detección:</strong> {{ p.riesgo_suicida_anexo1.hora|time:"H:i"|default:"No especificado" }}</p>
        <p><strong>Persona que detecta:</strong> {{ p.riesgo_suicida_anexo1.persona_detecta|default:"No especificado" }}</p>
        <h3>Relato de los Hechos:</h3>
        <pre>{{ p.riesgo_suicida_anexo1.relato_hechos|default:"Sin relato." }}</pre>
    </div>
    {% endif %}

    {% if p.riesgo_suicida_anexo2 %}
    <div class="section">
        <h2>Riesgo Suicida - Paso 2: Anexo 2: Derivación</h2>
        <h3>1. Antecedentes Establecimiento</h3>
        <p><strong>Fecha Derivación:</strong> {{ p.riesgo_suicida_anexo2.fecha_derivacion|date:"d/m/Y"|default:"No especificado" }}</p>
        <p><strong>Establecimiento:</strong> {{ p.riesgo_suicida_anexo2.establecimiento_nombre|default:"No especificado" }}</p>
        <p><strong>Profesional que Deriva:</strong> {{ p.riesgo_suicida_anexo2.profesional_deriva_nombre|default:"N/A" }} ({{ p.riesgo_suicida_anexo2.profesional_deriva_cargo|default:"N/A" }})</p>
        <p><strong>Contacto Profesional:</strong> {{ p.riesgo_suicida_anexo2.profesional_deriva_email|default:"N/A" }} / {{ p.riesgo_suicida_anexo2.profesional_deriva_telefono|default:"N/A" }}</p>
        <h3>2. Antecedentes Estudiante</h3>
        <p><strong>Nombre Estudiante:</strong> {{ p.riesgo_suicida_anexo2.estudiante_nombre|default:"No especificado" }}</p>
        <p><strong>RUN:</strong> {{ p.riesgo_suicida_anexo2.estudiante_run|default:"No especificado" }}</p>
        <p><strong>Fecha Nacimiento:</strong> {{ p.riesgo_suicida_anexo2.estudiante_fecha_nacimiento|date:"d/m/Y"|default:"N/A" }} (Edad: {{ p.riesgo_suicida_anexo2.estudiante_edad|default:"N/A" }})</p>
        <p><strong>Curso:</strong> {{ p.riesgo_suicida_anexo2.estudiante_curso|default:"N/A" }}</p>
        <p><strong>Adulto Responsable:</strong> {{ p.riesgo_suicida_anexo2.adulto_responsable_nombre|default:"N/A" }} (Tel: {{ p.riesgo_suicida_anexo2.adulto_responsable_telefono|default:"N/A" }})</p>
        <p><strong>Dirección:</strong> {{ p.riesgo_suicida_anexo2.estudiante_direccion|default:"N/A" }}</p>
        <h3>3. Motivo Derivación</h3>
        <pre>{{ p.riesgo_suicida_anexo2.motivo_derivacion|default:"Sin motivo especificado." }}</pre>
        <h3>4. Acciones Efectuadas</h3>
        <pre>{{ p.riesgo_suicida_anexo2.acciones_efectuadas|default:"Sin acciones especificadas." }}</pre>
    </div>
    {% endif %}

    {% if p.riesgo_suicida_anexo3 %}
    <div class="section">
        <h2>Riesgo Suicida - Paso 3: Anexo 3: Notificación Apoderado</h2>
        <p><strong>Fecha Notificación:</strong> {{ p.riesgo_suicida_anexo3.fecha|date:"d/m/Y"|default:"N/A" }}</p>
        <p><strong>Hora Notificación:</strong> {{ p.riesgo_suicida_anexo3.hora|time:"H:i"|default:"N/A" }}</p>
        <p><strong>Apoderado Notificado:</strong> {{ p.riesgo_suicida_anexo3.apoderado_nombre|default:"N/A" }} (RUN: {{ p.riesgo_suicida_anexo3.apoderado_run|default:"N/A" }})</p>
        <p><strong>Funcionario Notificante:</strong> {{ p.riesgo_suicida_anexo3.nombre_firma_funcionario|default:"N/A" }} (Cargo: {{ p.riesgo_suicida_anexo3.cargo_funcionario|default:"N/A" }})</p>
        <h3>Acciones a seguir por el apoderado:</h3>
        <pre>{{ p.riesgo_suicida_anexo3.acciones_a_seguir|default:"Sin acciones especificadas." }}</pre>
    </div>
    {% endif %}

    {% if p.riesgo_suicida_anexo4 %}
    <div class="section">
        <h2>Riesgo Suicida - Paso 4: Anexo 4: Reunión Clínica</h2>
        <p><strong>Fecha Reunión:</strong> {{ p.riesgo_suicida_anexo4.fecha|date:"d/m/Y"|default:"N/A" }}</p>
        <p><strong>Lugar:</strong> {{ p.riesgo_suicida_anexo4.lugar_reunion|default:"N/A" }}</p>
        <p><strong>Hora:</strong> {{ p.riesgo_suicida_anexo4.hora_inicio|time:"H:i"|default:"N/A" }} - {{ p.riesgo_suicida_anexo4.hora_termino|time:"H:i"|default:"N/A" }}</p>
        <h3>Asistentes:</h3>
        <pre>{{ p.riesgo_suicida_anexo4.asistentes|default:"No especificados." }}</pre>
        <h3>Puntos Tratados:</h3>
        <pre>{{ p.riesgo_suicida_anexo4.puntos_tratados|default:"No especificados." }}</pre>
        <h3>Acuerdos y Compromisos:</h3>
        <pre>{{ p.riesgo_suicida_anexo4.acuerdos|default:"No especificados." }}</pre>
        <p><strong>Próxima Reunión:</strong> {{ p.riesgo_suicida_anexo4.proxima_reunion_fecha|date:"d/m/Y"|default:"N/A" }} a las {{ p.riesgo_suicida_anexo4.proxima_reunion_hora|time:"H:i"|default:"N/A" }} en {{ p.riesgo_suicida_anexo4.proxima_reunion_lugar|default:"N/A" }}</p>
    </div>
    {% endif %}

    {% if p.riesgo_suicida_anexo5 %}
    <div class="section">
        <h2>Riesgo Suicida - Paso 5: Anexo 5: Hoja de Derivación</h2>
        <p><strong>Fecha Derivación:</strong> {{ p.riesgo_suicida_anexo5.fecha_derivacion|date:"d/m/Y"|default:"N/A" }}</p>
        <h3>Motivo de Derivación:</h3>
        <pre>{{ p.riesgo_suicida_anexo5.motivo_derivacion|default:"No especificado." }}</pre>
        <h3>Acciones: Entrevista con Apoderado:</h3>
        <pre>{{ p.riesgo_suicida_anexo5.acciones_entrevista_apoderado|default:"No especificado." }}</pre>
        <h3>Acciones: Coordinación Equipo de Salud:</h3>
        <pre>{{ p.riesgo_suicida_anexo5.acciones_coordinacion_salud|default:"No especificado." }}</pre>
        <h3>Otras Acciones:</h3>
        <pre>{{ p.riesgo_suicida_anexo5.acciones_otras|default:"No especificado." }}</pre>
        <p><strong>Funcionario Responsable:</strong> {{ p.riesgo_suicida_anexo5.responsable_nombre|default:"N/A" }} ({{ p.riesgo_suicida_anexo5.responsable_cargo|default:"N/A" }})</p>
        <p><strong>Contacto:</strong> {{ p.riesgo_suicida_anexo5.responsable_email|default:"N/A" }} / {{ p.riesgo_suicida_anexo5.responsable_telefono|default:"N/A" }}</p>
    </div>
    {% endif %}

    <!-- Ficha de Accidente Escolar para Casos de Salud -->

    {% if p.ficha_accidente_escolar %}
    <div class="section">
        <h2>Ficha de Accidente Escolar</h2>
        <p><strong>Estudiante:</strong> {{ p.ficha_accidente_escolar.estudiante_nombre|default:"N/A" }} ({{ p.ficha_accidente_escolar.estudiante_curso|default:"N/A" }})</p>
        <p><strong>Fecha y Hora:</strong> {{ p.ficha_accidente_escolar.fecha_hora_accidente|date:"d/m/Y H:i"|default:"N/A" }}</p>
        <h3>Descripción del Accidente:</h3>
        <pre>{{ p.ficha_accidente_escolar.descripcion_accidente|default:"Sin descripción." }}</pre>
        <h3>Primeros Auxilios Realizados:</h3>
        <pre>{{ p.ficha_accidente_escolar.primeros_auxilios|default:"Sin descripción." }}</pre>
        <p><strong>Apoderado Avisado:</strong> {{ p.ficha_accidente_escolar.aviso_apoderado_nombre|default:"N/A" }}</p>
        <p><strong>Funcionario que avisa:</strong> {{ p.ficha_accidente_escolar.aviso_funcionario|default:"N/A" }}</p>
        {% if p.ficha_accidente_escolar.traslado_centro %}
            <p><strong>Traslado a:</strong> {{ p.ficha_accidente_escolar.traslado_centro|default:"N/A" }}</p>
            <p><strong>Funcionario que traslada:</strong> {{ p.ficha_accidente_escolar.traslado_funcionario|default:"N/A" }}</p>
        {% endif %}
    </div>
    {% endif %}
    
    {% endwith %}

    <div class="footer">
        Documento generado el {{ fecha_actual|date:"d/m/Y H:i" }} por {{ request.user.get_full_name|default:request.user.username }}.
    </div>
</body>
</html>