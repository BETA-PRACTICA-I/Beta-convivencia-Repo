{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <title>Convivencia Escolar</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="{% static 'Validaciones/css/homepagestyles.css'%}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="{% static 'Validaciones/js/Script.js' %}" defer></script>

</head>
<body>

    <header class="top-bar">
        <div class="logo-and-nav">
            <div class="logo">
                <img src="{% static 'Validaciones/img/virgenbkn.png' %}" class="logo-image" alt="Logo">
            </div>
            <nav class="nav-menu">
                <a href="#" class="nav-item">
                    <i class="fa-solid fa-house"></i>
                </a>
            </nav>
        </div>

        <div class="action-hamburger">
            <button class="hamburger-menu">
                <i class="fa-solid fa-bars"></i>
            </button>
        </div>
    </header>

    <main id= "main-content" class = "main-content">
        <h1 class="greeting">Hola, Usuario!</h1>
        <button id="abrir-protocolo-btn" class="abrir-protocolo">Abrir protocolo</button>
    </main>
    <!--barra superior y 15 botones-->
    <section id="protocolo-section">
        <div class="protocolo-header">
            <h2 class="protocolo-titulo">Selecciona el Protocolo a Iniciar</h2>
            <button class="boton-volver" id="volver-btn">&larr; Volver</button>
        </div>
        <div class="botones-grid">
            {% for tipo in tipos %}
                <a href="{% url 'protocolo1:iniciar_protocolo' tipo.id %}" class="boton-protocolo">
                    <i class="fa-solid fa-folder"></i>
                    <span>{{ forloop.counter }}. {{ tipo.nombre }}</span>
                </a>
            {% empty %}
                <p>No hay tipos de protocolo. Crea alguno en admin.</p>
            {% endfor %}
        </div>
    </section>

    DEBUG: protocolos={{ protocolos|length }}  tipos={{ tipos|length }} 

    <table class="protocol-table" id="protocol-table">
        <thead>
            <tr>
                <th>Nombres denunciantes</th>
                <th>Curso(s)</th>
                <th>Protocolo activado</th>
                <th>Estado</th>
                <th>Persona a cargo</th>
                <th>Fecha de apertura</th>
                <th>Fecha límite</th>
                <th>ID</th>
            </tr>
        </thead>
        <tbody>
            {% for p in protocolos %}
                <tr>
                <td>{{ p.ficha_denuncia.nombre_denunciante|default:"N/A" }}</td>
                <td>{{ p.curso }}</td>
                <td>
                    {% if p.tipo_protocolo %}
                    {{ p.tipo_protocolo.numero }}. {{ p.tipo_protocolo.nombre }}
                    {% else %}—{% endif %}
                </td>
                <td class="estado-cell">
                    <div class="estado-dropdown">
                    <button class="estado-btn">
                        <span class="estado-texto">{{ p.get_estado_display|default:p.estado }}</span>
                        <span class="icono-desplegable">▾</span>
                    </button>
                    <div class="estado-opciones">
                        <a href="#" data-value="Resuelto">Resuelto</a>
                        <a href="#" data-value="Pendiente">Pendiente</a>
                        <a href="#" data-value="Vencido">Vencido</a>
                    </div>
                    </div>
                </td>
                <td>
                    {% if p.persona_a_cargo %}
                    {{ p.persona_a_cargo.get_full_name|default:p.persona_a_cargo }}
                    {% else %}—{% endif %}
                </td>
                <td>{{ p.fecha_apertura|date:"d/m/Y" }}</td>
                <td>{{ p.fecha_limite|date:"d/m/Y" }}</td>
                <td>{{ p.id }}</td>
                </tr>
            {% empty %}
                <tr><td colspan="8" style="text-align:center;">No hay protocolos registrados.</td></tr>
            {% endfor %}
        </tbody>
    </table>






    <script>
    // Espera a que todo el contenido de la página se cargue
    document.addEventListener('DOMContentLoaded', function() {

        // Selecciona todos los botones de estado en la tabla
        const botonesEstado = document.querySelectorAll('.estado-btn');

        botonesEstado.forEach(boton => {
            boton.addEventListener('click', function(event) {
                // Detiene la propagación para que no se activen otros eventos del <tr> o <td>
                event.stopPropagation(); 
                
                // Encuentra el menú de opciones correspondiente a este botón
                const opciones = this.nextElementSibling;
                
                // Muestra u oculta el menú
                opciones.classList.toggle('mostrar');
            });
        });

        // Selecciona todas las opciones dentro de los menús desplegables
        const linksOpciones = document.querySelectorAll('.estado-opciones a');

        linksOpciones.forEach(link => {
            link.addEventListener('click', function(event) {
                event.preventDefault(); // Evita que el link recargue la página
                event.stopPropagation();

                const nuevoEstado = this.dataset.value; // Obtiene el valor (Ej: "Resuelto")
                const menu = this.parentElement; // El div .estado-opciones
                const boton = menu.previousElementSibling; // El botón .estado-btn
                const textoBoton = boton.querySelector('.estado-texto');

                // Actualiza el texto del botón con la opción seleccionada
                textoBoton.textContent = nuevoEstado;

                // Oculta el menú
                menu.classList.remove('mostrar');

                // Aquí, en el futuro, podrías añadir una llamada (AJAX/Fetch) 
                // para guardar el nuevo estado en la base de datos.
                console.log(`Estado cambiado a: ${nuevoEstado}`);
            });
        });

        // Cierra el menú si el usuario hace clic en cualquier otro lugar de la página
        window.addEventListener('click', function(event) {
            // Busca todos los menús que estén abiertos
            const menúsAbiertos = document.querySelectorAll('.estado-opciones.mostrar');
            menúsAbiertos.forEach(menu => {
                // Y los cierra
                menu.classList.remove('mostrar');
            });
        });
    });
    </script>


</body>
</html>