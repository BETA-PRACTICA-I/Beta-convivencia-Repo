{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <title>Panel de Dirección - Convivencia Escolar</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <!-- 1. Estilos Globales (Tabla base, tipografía) -->
    <link rel="stylesheet" href="{% static 'Validaciones/css/homepagestyles.css'%}">
    
    <!-- 2. Estilos Específicos del Director (Gráficos, FAB, Layout limpio) -->
    <link rel="stylesheet" href="{% static 'Validaciones/css/director.css'%}">
    
    <!-- Iconos y Scripts -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="{% static 'Validaciones/js/Script.js' %}" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

    <!-- BARRA SUPERIOR LIMPIA -->
    <header class="top-bar">
        <div class="logo-and-nav">
            <div class="logo">
                <img src="{% static 'Validaciones/img/virgenbkn.png' %}" class="logo-image" alt="Logo">
            </div>
            <nav class="nav-menu">
                <a href="{% url 'Validaciones:directorhomepage' %}" class="nav-item" title="Inicio">
                    <i class="fa-solid fa-house"></i>
                </a>
                <a href="{% url 'Validaciones:Almacen' %}?back=director" class="nav-item" title="Almacén">
                    <i class="fa-solid fa-warehouse"></i>
                </a>
            </nav>
        </div>
        
        <div class="hamburger-dropdown">
            <button class="hamburger-btn"><i class="fa-solid fa-bars"></i></button>
            <div class="hamburger-opciones">
                <a href="{% url 'Validaciones:Almacen' %}?back=director">Almacén</a>
                <a href="{% url 'Validaciones:login' %}">Cerrar sesión</a>
            </div>
        </div>
    </header>

    <!-- CONTENIDO PRINCIPAL (Flujo vertical ordenado) -->
    <main class="main-content">
        <h1 class="greeting">Bienvenido, Sr. Director</h1>

        <!-- SECCIÓN DE GRÁFICOS -->
        <div class="charts-section">
            <!-- Tarjeta 1: Tipos -->
            <div class="chart-card">
                <h3>Distribución por Tipo</h3>
                <div class="chart-container-inner">
                    <canvas id="protocolosPorTipoChart"></canvas>
                </div>
            </div>
            
            <!-- Tarjeta 2: Estados -->
            <div class="chart-card">
                <h3>Estado General</h3>
                <div class="chart-container-inner">
                    <canvas id="protocolosPorEstadoChart"></canvas>
                </div>
            </div>
        </div>

        <!-- SECCIÓN TABLA -->
        <div class="section-header">
            <h2>Protocolos Activos</h2>
        </div>

        <table class="protocol-table" id="protocol-table">
            <thead>
                <tr>
                    <th>Involucrados</th>
                    <th>Curso(s)</th>
                    <th>Protocolo</th>
                    <th>Estado</th>
                    <th>Encargado</th>
                    <th>Inicio</th>
                    <th>Límite</th>
                    <th>ID</th>
                </tr>
            </thead>
            <tbody>
                {% for p in protocolos %}
                    <tr class="protocol-row" 
                        data-protocolo-id="{{ p.id }}" 
                        data-url-ver="{% url 'protocolos:ver_protocolo' p.id %}" 
                        data-url-descargar="{% url 'protocolos:descargar_protocolo_pdf' p.id %}"
                        data-url-complementar="{% url 'protocolos:complementar_protocolo' p.id %}">
                        
                        <td><strong>{{ p.primer_involucrado|default:"N/A" }}</strong></td>
                        <td>{{ p.primer_curso|default:"N/A" }}</td>
                        <td>{{ p.tipo.nombre|default:"—" }}</td>
                        <td>
                            {% if p.estado == 'Resuelto' %}
                                <span style="color:#28a745; font-weight:bold;">Resuelto</span>
                            {% elif p.estado == 'Vencido' %}
                                <span style="color:#dc3545; font-weight:bold;">Vencido</span>
                            {% else %}
                                <span style="color:#ffc107; font-weight:bold; text-shadow: 0 0 1px #999;">Pendiente</span>
                            {% endif %}
                        </td>
                        <td>{{ p.creador.get_full_name|default:p.creador.username }}</td>
                        <td>{{ p.fecha_creacion|date:"d/m/Y" }}</td>
                        <td>{{ p.fecha_limite|date:"d/m/Y" }}</td>
                        <td>#{{ p.id }}</td>
                    </tr>
                {% empty %}
                    <tr><td colspan="8" style="text-align:center; padding:30px; color:#666;">No hay protocolos activos.</td></tr>
                {% endfor %}
            </tbody>
        </table>
        
        <!-- Espacio al final para que el botón flotante no tape nada -->
        <div style="height: 80px;"></div>
    </main>

    <!-- BOTÓN FLOTANTE (FAB) -->
    <a href="{% url 'Validaciones:Almacen' %}?back=director" class="fab-almacen" title="Ir al Almacén">
        <i class="fa-solid fa-warehouse"></i>
    </a>

    <!-- LÓGICA DE GRÁFICOS -->
    <script>
        // Recibimos los datos desde Django
        const labelsTipos = JSON.parse('{{ chart_labels_tipos|safe }}');
        const dataTipos = JSON.parse('{{ chart_data_tipos|safe }}');
        const labelsEstados = JSON.parse('{{ chart_labels_estados|safe }}');
        const dataEstados = JSON.parse('{{ chart_data_estados|safe }}');

        document.addEventListener('DOMContentLoaded', function() {
            Chart.defaults.font.family = "'Segoe UI', sans-serif";
            Chart.defaults.color = '#555';

            // 1. Gráfico de Barras
            const ctxTipos = document.getElementById('protocolosPorTipoChart');
            if (ctxTipos) {
                new Chart(ctxTipos, {
                    type: 'bar',
                    data: {
                        labels: labelsTipos,
                        datasets: [{
                            label: 'Casos',
                            data: dataTipos,
                            backgroundColor: 'rgba(0, 51, 102, 0.8)', // Azul institucional
                            borderRadius: 4,
                            barPercentage: 0.7
                        }]
                    },
                    options: {
                        maintainAspectRatio: false, // ¡Vital para que CSS controle el tamaño!
                        responsive: true,
                        plugins: { legend: { display: false } },
                        scales: {
                            y: { beginAtZero: true, ticks: { stepSize: 1 }, grid: { borderDash: [5, 5] } },
                            x: { grid: { display: false } }
                        }
                    }
                });
            }

            // 2. Gráfico de Donut
            const ctxEstados = document.getElementById('protocolosPorEstadoChart');
            if (ctxEstados) {
                new Chart(ctxEstados, {
                    type: 'doughnut',
                    data: {
                        labels: labelsEstados,
                        datasets: [{
                            data: dataEstados,
                            backgroundColor: ['#FFC107', '#28A745', '#DC3545'], // Amarillo, Verde, Rojo
                            borderWidth: 0,
                            hoverOffset: 8
                        }]
                    },
                    options: {
                        maintainAspectRatio: false, // ¡Vital para que CSS controle el tamaño!
                        responsive: true,
                        cutout: '70%',
                        plugins: {
                            legend: { position: 'bottom', labels: { usePointStyle: true, padding: 20 } }
                        }
                    }
                });
            }

            // Lógica Menú Hamburguesa
            const hb = document.querySelector('.hamburger-btn');
            const hd = document.querySelector('.hamburger-dropdown');
            if(hb && hd){
                hb.addEventListener('click', (e) => { e.stopPropagation(); hd.classList.toggle('active'); });
                window.addEventListener('click', (e) => { if(!hd.contains(e.target)) hd.classList.remove('active'); });
            }
        });
    </script>

</body>
</html>