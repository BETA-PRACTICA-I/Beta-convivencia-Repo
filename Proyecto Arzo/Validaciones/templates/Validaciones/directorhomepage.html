{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <title>Panel del Director - Convivencia Escolar</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Cargamos los mismos estilos que las otras homepages -->
    <link rel="stylesheet" href="{% static 'Validaciones/css/homepagestyles.css'%}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- ¡IMPORTANTE! Añadimos la librería Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Estilos adicionales para los botones de acción de la tabla (copiados de abogadohomepage.html) -->
    <style>
        .acciones-cell {
            text-align: center;
        }
        .accion-btn {
            color: #333;
            margin: 0 5px;
            text-decoration: none;
            font-size: 1.1rem;
        }
        .accion-btn:hover {
            color: rgb(30, 81, 160); /* Azul Primario */
        }

        /* --- ¡NUEVO! Estilos para los Gráficos --- */
        .dashboard-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 2rem;
            padding: 1rem 2rem;
            max-width: 1400px;
            margin: 0 auto 2rem auto;
        }
        .chart-card {
            background: #fff;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        .chart-card h3 {
            margin-top: 0;
            margin-bottom: 1.5rem;
            text-align: center;
            color: #333;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
    </style>
</head>
<body>

    <!-- Misma barra superior que las otras vistas -->
    <header class="top-bar">
        <div class="logo-and-nav">
            <div class="logo">
                <img src="{% static 'Validaciones/img/virgenbkn.png' %}" class="logo-image" alt="Logo">
            </div>
            <nav class="nav-menu">
                <a href="#" class="nav-item">
                    <i class="fa-solid fa-house"></i>
                </a>
            </nav>
        </div>
        <div class="action-hamburger">
            <button class="hamburger-menu">
                <i class="fa-solid fa-bars"></i>
            </button>
        </div>
    </header>

    <!-- Saludo principal -->
    <main id="main-content" class="main-content">
        <h1 class="greeting">Panel de Director - ¡Hola, {{ user.get_full_name|default:user.username }}!</h1>
    </main>

    <!-- --- ¡NUEVO! Sección del Dashboard para Gráficos --- -->
    <section class="dashboard-container">
        
        <!-- Gráfico 1: Protocolos por Tipo -->
        <div class="chart-card">
            <h3>Protocolos por Tipo</h3>
            <canvas id="protocolosPorTipoChart"></canvas>
        </div>
        
        <!-- Gráfico 2: Protocolos por Estado -->
        <div class="chart-card">
            <h3>Protocolos por Estado</h3>
            <!-- Usamos un div contenedor para limitar el tamaño del gráfico circular -->
            <div style="max-width: 400px; margin: 0 auto;">
                <canvas id="protocolosPorEstadoChart"></canvas>
            </div>
        </div>

    </section>
    <!-- --- Fin de la sección del Dashboard --- -->


    <!-- Título para la tabla de abajo -->
    <div class="main-content" style="padding-top: 0;">
        <h2 class="greeting" style="font-size: 1.8rem; margin: 0;">Listado de Protocolos</h2>
    </div>

    <!-- Misma tabla de "solo lectura" que ve el Abogado -->
    <table class="protocol-table" id="protocol-table" style="margin-top: 1rem;">
        <thead>
            <tr>
                <th>Involucrados</th>
                <th>Curso(s)</th>
                <th>Protocolo activado</th>
                <th>Estado</th>
                <th>Persona a cargo</th>
                <th>Fecha de apertura</th>
                <th>Fecha límite</th>
                <th>ID</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody>
            {% for p in protocolos %}
                <tr class="protocol-row">
                    <td title="{{ p.resumen_involucrados|default:'N/A' }}">
                        {{ p.primer_involucrado|default:"N/A" }}
                    </td>
                    <td title="{{ p.resumen_cursos|default:'N/A' }}">
                        {{ p.primer_curso|default:"N/A" }}
                    </td>
                    <td>
                        {% if p.tipo.nombre %}
                            {{ p.tipo.nombre }}
                        {% else %}—{% endif %}
                    </td>
                    <td>
                        {{ p.get_estado_display|default:p.estado }}
                    </td>
                    <td>
                        {{ p.creador.get_full_name|default:p.creador.username }}
                    </td>
                    <td>{{ p.fecha_creacion|date:"d/m/Y" }}</td>
                    <td>{{ p.fecha_limite|date:"d/m/Y" }}</td>
                    <td>{{ p.id }}</td>
                    <td class="acciones-cell">
                        <a href="{% url 'protocolos:ver_protocolo' p.id %}" title="Ver Protocolo" class="accion-btn">
                            <i class="fa-solid fa-eye"></i>
                        </a>
                        <a href="{% url 'protocolos:descargar_protocolo_pdf' p.id %}" title="Descargar PDF" class="accion-btn">
                            <i class="fa-solid fa-file-pdf"></i>
                        </a>
                    </td>
                </tr>
            {% empty %}
                <tr><td colspan="9" style="text-align:center;">No hay protocolos registrados.</td></tr>
            {% endfor %}
        </tbody>
    </table>

    <!-- --- ¡NUEVO! Script para inicializar los Gráficos --- -->
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            
            // --- ¡DATOS REALES! ---
            // Cargamos los datos JSON que pasamos desde la vista de Django
            // ¡AHORA SÍ! Usamos el filtro 'safe' de Django para imprimir el JSON
            // directamente como un objeto de JavaScript.
            
            // Datos para el Gráfico de Barras (Protocolos por Tipo)
            const dataTipos = {
                labels: {{ chart_labels_tipos|safe }},
                datasets: [{
                    label: 'Cantidad de Protocolos',
                    data: {{ chart_data_tipos|safe }}, 
                    backgroundColor: 'rgba(30, 81, 160, 0.7)', // Azul Primario
                    borderColor: 'rgba(30, 81, 160, 1)',
                    borderWidth: 1
                }]
            };

            // Datos para el Gráfico Circular (Protocolos por Estado)
            const dataEstados = {
                labels: {{ chart_labels_estados|safe }},
                datasets: [{
                    label: 'Protocolos',
                    data: {{ chart_data_estados|safe }}, 
                    backgroundColor: [
                        'rgba(245, 158, 11, 0.8)', // Amarillo (Pendiente)
                        'rgba(16, 185, 129, 0.8)', // Verde (Resuelto)
                        'rgba(239, 68, 68, 0.8)'   // Rojo (Vencido)
                    ],
                    borderColor: [
                        'rgba(245, 158, 11, 1)',
                        'rgba(16, 185, 129, 1)',
                        'rgba(239, 68, 68, 1)'
                    ],
                    borderWidth: 1
                }]
            };

            // --- Inicializar Gráfico de Barras ---
            const ctxTipos = document.getElementById('protocolosPorTipoChart');
            if (ctxTipos) {
                new Chart(ctxTipos, {
                    type: 'bar',
                    data: dataTipos,
                    options: {
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    // Asegura que los ticks del eje Y sean números enteros
                                    stepSize: 1 
                                }
                            }
                        },
                        responsive: true,
                        plugins: {
                            legend: {
                                display: false // Ocultamos la leyenda para este gráfico
                            }
                        }
                    }
                });
            }

            // --- Inicializar Gráfico Circular ---
            const ctxEstados = document.getElementById('protocolosPorEstadoChart');
            if (ctxEstados) {
                new Chart(ctxEstados, {
                    type: 'pie',
                    data: dataEstados,
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'top', // Ponemos la leyenda arriba
                            }
                        }
                    }
                });
            }
        });
    </script>

</body>
</html>
